/**
 * Created by shadygabal on 1/8/16.
 */


var pushNotificationHelper = (function() {
    var apn  = require("apn");
    var ArrayHelper = require('app/helpers/ArrayHelper.js');

    var apnError = function(err){
        console.log("APN Error:", err);
    };

    var options = {
        "cert": "production_cert.pem",
        "key":  "production_key.pem",
        "passphrase": null,
        //"gateway": "gateway.sandbox.push.apple.com",
        "port": 2195,
        //"production" : true,
        "enhanced": true,
        //"cacheLength": 5
    };
    options.errorCallback = apnError;

    var feedBackOptions = {
        "batchFeedback": true,
        "interval": 300
    };

    var apnConnection, feedback;

    var pushNotifier;

    apnConnection = new apn.Connection(options);
    console.log("initializing push notifier...");
    feedback = new apn.Feedback(feedBackOptions);
    feedback.on("feedback", function(devices) {
        devices.forEach(function(item) {
            console.log("FEEDBACK. item.device: " + item.device + "item.time: " + item.time);
            //TODO Do something with item.device and item.time;
        });
    });


    return {
        sendTestNotificationWithToken : function(deviceToken){
            myDevice = new apn.Device(deviceToken);
            note = new apn.Notification();

            note.expiry = Math.floor(Date.now() / 1000) + 3600; // Expires 1 hour from now.
            //note.sound = "ping.aiff";
            note.alert = "Testing notifications";

            if (apnConnection) {
                console.log("Pushing test push notification...");
                apnConnection.pushNotification(note, myDevice);
            }
        },
        sendPushNotification : function (user, message, payload, options) {
            if (user.deviceToken) {
                console.log("Sending " + message + " to " + user.firstName + "...");
                if (!payload)
                    payload = {};
                if (!options)
                    options = {};

                var myDevice, note;

                myDevice = new apn.Device(user.deviceToken);
                note = new apn.Notification();
                if (options["badgeCount"]) {
                    note.badge = options["badgeCount"];
                }

                note.expiry = Math.floor(Date.now() / 1000) + 3600; // Expires 1 hour from now.
                //note.sound = "ping.aiff";
                note.alert = message;



                note.payload = payload; //additional info


                if (apnConnection) {
                    console.log("Pushing push notification: '" + message + "' ...");
                    apnConnection.pushNotification(note, myDevice);
                }
            }
            else if (user.testUser){
                console.log("Test User: " + user.fullName + " received notification: " + message);
            }
            else{
                console.log("Attempt to send push notification '" + message + "' failed because user '" + user.firstName + "' does not have a device token");
            }

        },
        sendNotification : function(user, notification){
            console.log("Sending notification with id: " + notification._id);

            var payload = {"notification" : notification.jsonObject()};
            var badgeCount = user.numUnseenNotifications;
            this.sendPushNotification(user, notification.body, payload, {"badgeCount" : badgeCount});
        }
        //sendPushNotificationsForSoiree : function (soiree) {
        //    for(var i = 0; i < soiree._usersAttending.length; i++){
        //        var user = soiree._usersAttending[i];
        //        if (user.deviceToken){
        //            var message = "";
        //            this.sendPushNotification(user, message);
        //        }
        //    }
        //}

        }

}());

module.exports = pushNotificationHelper;


/*
usage
 pushNotifier = require("./pushNotifier");
 pushNotifier.init();
 //use valid device token to get it working
 pushNotifier.process({token:'', message:'Test message', from: 'sender'});

 */
